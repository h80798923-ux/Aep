name: TrixieOS Independent Linux ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential wget curl git \
          bison flex gawk texinfo \
          libncurses-dev libssl-dev \
          libelf-dev libtool \
          xorriso grub-pc-bin grub-common \
          cpio rsync bc meson ninja-build

    - name: Prepare workspace
      run: |
        mkdir -p trixieos sysroot iso/boot/grub

    # -------------------------
    # Linux Kernel
    # -------------------------
    - name: Build Linux kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.15.tar.xz
        tar -xf linux-6.6.15.tar.xz
        cd linux-6.6.15
        make defconfig
        make -j$(nproc)
        make INSTALL_MOD_PATH=$GITHUB_WORKSPACE/sysroot modules_install
        cp arch/x86/boot/bzImage $GITHUB_WORKSPACE/sysroot/vmlinuz

    # -------------------------
    # glibc
    # -------------------------
    - name: Build glibc
      run: |
        wget https://ftp.gnu.org/gnu/libc/glibc-2.39.tar.xz
        tar -xf glibc-2.39.tar.xz
        mkdir glibc-build
        cd glibc-build
        ../glibc-2.39/configure \
          --prefix=/usr \
          --enable-kernel=4.14
        make -j$(nproc)
        make DESTDIR=$GITHUB_WORKSPACE/sysroot install

    # -------------------------
    # BusyBox
    # -------------------------
    - name: Build BusyBox
      run: |
        wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
        tar -xf busybox-1.36.1.tar.bz2
        cd busybox-1.36.1
        make defconfig
        make -j$(nproc)
        make CONFIG_PREFIX=$GITHUB_WORKSPACE/sysroot install

    # -------------------------
    # systemd
    # -------------------------
    - name: Build systemd
      run: |
        wget https://github.com/systemd/systemd/archive/refs/tags/v255.tar.gz
        tar -xf v255.tar.gz
        cd systemd-255
        meson setup build --prefix=/usr --sysconfdir=/etc --localstatedir=/var
        ninja -C build
        DESTDIR=$GITHUB_WORKSPACE/sysroot ninja -C build install

    # -------------------------
    # dbus
    # -------------------------
    - name: Build dbus
      run: |
        wget https://dbus.freedesktop.org/releases/dbus/dbus-1.14.10.tar.xz
        tar -xf dbus-1.14.10.tar.xz
        cd dbus-1.14.10
        ./configure --prefix=/usr
        make -j$(nproc)
        make DESTDIR=$GITHUB_WORKSPACE/sysroot install

    # -------------------------
    # Openbox placeholder
    # -------------------------
    - name: Install Openbox placeholder
      run: |
        mkdir -p sysroot/usr/bin
        echo '#!/bin/sh' > sysroot/usr/bin/openbox
        echo 'echo "Openbox installed. Xorg required."' >> sysroot/usr/bin/openbox
        chmod +x sysroot/usr/bin/openbox

    # -------------------------
    # OS identity
    # -------------------------
    - name: TrixieOS identity
      run: |
        mkdir -p sysroot/etc
        cat <<'EOF' > sysroot/etc/os-release
NAME="TrixieOS"
ID=trixieos
VERSION="0.1"
PRETTY_NAME="TrixieOS ProjectA"
EOF

        echo "TrixieOS ProjectA tarafından yapıldı" > sysroot/etc/issue

    # -------------------------
    # trx package manager
    # -------------------------
    - name: trx package system
      run: |
        cat <<'EOF' > sysroot/usr/bin/trx
#!/bin/sh
echo "trx package manager (TrixieOS)"
EOF
        chmod +x sysroot/usr/bin/trx

    # -------------------------
    # Initramfs
    # -------------------------
    - name: Create initramfs
      run: |
        cd sysroot
        find . | cpio -o -H newc | gzip > ../initramfs.gz

    # -------------------------
    # ISO + GRUB
    # -------------------------
    - name: Build ISO
      run: |
        cp sysroot/vmlinuz iso/boot/vmlinuz
        cp initramfs.gz iso/boot/initramfs.gz

        cat <<'EOF' > iso/boot/grub/grub.cfg
set timeout=3
menuentry "TrixieOS (Console)" {
  echo "TrixieOS ProjectA"
  linux /boot/vmlinuz quiet
  initrd /boot/initramfs.gz
}
EOF

        grub-mkrescue -o TrixieOS.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-ISO
        path: TrixieOS.iso
